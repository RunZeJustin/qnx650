
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-us" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta name="copyright" content="(C) Copyright 2005" />
      <meta name="DC.rights.owner" content="(C) Copyright 2005" />
      <meta name="DC.Type" content="concept" />
      <meta name="DC.Title" content="Analyzing allocation patterns" />
      <meta name="abstract" content="" />
      <meta name="description" content="" />
      <meta name="DC.Relation" scheme="URI" content="../topic/memory_Memory_Optimization.html" />
      <meta name="DC.Relation" scheme="URI" content="../topic/memory_ProcessMem_.html" />
      <meta name="DC.Relation" scheme="URI" content="../topic/memory_Performance_Of_Heap_Allocations.html" />
      <meta name="DC.Relation" scheme="URI" content="../topic/memory_OptHeapMem_.html" />
      <meta name="DC.Relation" scheme="URI" content="../topic/memory_AllocationOverhead_.html" />
      <meta name="DC.Relation" scheme="URI" content="../topic/memory_EstimatingAllocationSize_.html" />
      <meta name="DC.Relation" scheme="URI" content="../topic/memory_TuningAllocator_.html" />
      <meta name="DC.Relation" scheme="URI" content="../topic/memory_OptstaticStackMem_.html" />
      <meta name="DC.Format" content="XHTML" />
      <meta name="DC.Identifier" content="Analyzingallocationpatterns" />
      <meta name="DC.Language" content="en-us" />
      <link rel="stylesheet" type="text/css" href="../commonltr.css" />
      <link rel="stylesheet" type="text/css" href="../style.css" />
      <title>Analyzing allocation patterns</title>
   </head>
   <body id="Analyzingallocationpatterns"><a name="Analyzingallocationpatterns" shape="rect">
         <!-- --></a>
      
      
      
      <h1 class="topictitle1">Analyzing allocation patterns</h1>
      
      
      
      <div>
         <p></p>
         
         
         <p>After you have prepared a memory analysis (profiling) session, double-click on a session to open the Memory Analysis Session
            viewer. The Allocations page shows the Overview: Requested Allocations chart. For example, let's take a closer look at this
            chart. 
         </p>
         
         
         <p>
            <span><img src="../images/ory_analyzingallocpatterns_.xml_d130160e17.jpg" alt="Overview of Requested Allocations chart for memory allocations and deallocations" /></span>
            
         </p>
         
         
         <p>This example chart shows memory allocation and deallocation events that are generated by the <tt>malloc()</tt> and <tt>free()</tt> functions and their derivatives. The X-axis represents the event number (which can change to a timestamp), and the Y-axis
            represents the size (in bytes) of the allocation (if a positive value), or the deallocation (if a negative value). 
         </p>
         
         
         <p>Let's take a closer look at the bottom portion of the chart. The <span class="uicontrol">Page</span> field shows the scrollable page number, the <span class="uicontrol">Total Points</span> field shows how many recorded events there are, the <span class="uicontrol">Points per page</span> field shows how many events can fit onto this page, and the <span class="uicontrol">Total Pages</span> field shows how many chart pages there are in total. 
         </p>
         
         
         <p>For this example, there are <cite>202</cite> events that fit within the chart; however for some larger charts, all of them would not likely fit on this single chart.
            If that were the case, there are several choices available. First, you can attempt to reduce the value in the <span class="uicontrol">Points per page</span> field to <cite>50</cite>, for example. 
         </p>
         
         
         <p>
            <span><img src="../images/ory_analyzingallocpatterns_.xml_d130160e63.jpg" alt="Overview of modified Requested Allocations chart for memory allocations and deallocations" /></span>
            
         </p>
         
         
         <p>However, in the case where the number of events is large (the X-axis value is a large number, 1482 events), changing the value
            of <span class="uicontrol">Points per page</span> field might not significantly improve the visual appearance of the data in the chart. For this example, there are 1482 events,
            and all of these events don't fit on a single chart: 
         </p>
         
         
         <p>
            <span><img src="../images/ory_analyzingallocpatterns_.xml_d130160e78.jpg" alt="Overview of modified Requested Allocations chart for memory allocations and deallocations" /></span>
            
         </p>
         
         
         <p>If you reduce the value in the <span class="uicontrol">Points per page</span> field to <cite>500</cite>, the graphical representation will be better; however, it's still not very useful. 
         </p>
         
         
         <p>Alternatively, you can use filters to exclude data from the chart. If you look at the Y-axis of the following chart, notice
            some large allocations at the beginning. To see this area more closely, select this region with the mouse. The chart and table
            at the top change to populate with the data from the selected region. 
         </p>
         
         
         <p>Now, locate the large allocation and check its stack trace. Notice that this allocation belongs to the function called <tt>monstartup()</tt>, which isn't part of the user defined code; meaning that it can't be optimized, and it can probably be excluded from the
            events of interest. 
         </p>
         
         
         <p>
            <span><img src="../images/ory_analyzingallocpatterns_.xml_d130160e106.jpg" alt="Detail allocations" /></span>
            
         </p>
         
         
         <p>You can use a filter to exclude this function. Right-click on the Overview chart's canvas area and select <span class="uicontrol">Filters...</span> from the menu. Type <tt>1-1000</tt> in the <span class="uicontrol">Requested Size Range</span> field. The overview will look like this: 
         </p>
         
         
         <p>
            <span><img src="../images/ory_analyzingallocpatterns_.xml_d130160e127.jpg" alt="Requested allocations" /></span>
            
         </p>
         
         
         <p>From the filtered view, there is a pattern: the allocation is followed by a deallocation, and the size of the allocations
            grows over time. Typically, this growth is the result of the <tt>realloc()</tt> pattern. To confirm the speculation, return to the <span class="uicontrol">Filters...</span> menu option, and disable (un-check) all of the allocation functions, except for the <span class="uicontrol">realloc-alloc</span> option. Notice that the growth occurs with a very small increment. 
         </p>
         
         
         <p>
            <span><img src="../images/ory_analyzingallocpatterns_.xml_d130160e148.jpg" alt="Requested allocations with filters" /></span>
            
         </p>
         
         
         <p>Next, select a region of the Overview chart and explore the event table. Notice the events with the same stack trace; this
            is an example of a <tt>realloc()</tt> call with a bad (too small) increment (the pattern for a shortsighted <tt>realloc()</tt>). 
         </p>
         
         
         <p>
            <span><img src="../images/ory_analyzingallocpatterns_.xml_d130160e167.jpg" alt="realloc call with a bad increment" /></span>
            
         </p>
         
         
         <p>Notice that the string in the example was re-allocated approximately 400 times (from 11 bytes to 889 bytes). Based on that
            information, you can optimize this particular call (for performance) by either adding some constant overhead to each <tt>realloc()</tt> call, or by double allocating the size. In this particular example, if you double allocate the size, re-compile and re-run
            the application, and then open the editor and filter all but the <tt>realloc()</tt> events, you'll obtain the following: 
         </p>
         
         
         <p>
            <span><img src="../images/ory_analyzingallocpatterns_.xml_d130160e185.jpg" alt="Requested allocation with only realloc events" /></span>
            
         </p>
         
         
         <p>The figure above shows only 12 <tt>realloc()</tt> events instead of the original 400. This would significantly improve the performance; however, the maximum allocated size
            is 1452 bytes (600 bytes in excess of what is required). You can adjust the <tt>realloc()</tt> code to better tune it for a typical application run. Normally, you should make <tt>realloc()</tt> sizes similar to the allocator block sizes. 
         </p>
         
         
         <p>To check other events, in the <span class="uicontrol">Filters</span> menu, enable all functions, except for <tt>realloc()</tt>. Select a region in the overview: 
         </p>
         
         
         <p>
            <span><img src="../images/ory_analyzingallocpatterns_.xml_d130160e215.jpg" alt="Requested allocation with focused region" /></span>
            
         </p>
         
         
         <p>In the <span class="uicontrol">Details</span> chart, the <span class="uicontrol">alloc/free</span> events have the same size. This is the typical pattern for a short-lived object. 
         </p>
         
         
         <p>
            <span><img src="../images/ory_analyzingallocpatterns_.xml_d130160e234.jpg" alt="Allocations: pattern for a short-lived object" /></span>
            
         </p>
         
         
         <p>To navigate to the source code from the stack trace view, double-click on a row for the stack trace. </p>
         
         
         <p>
            <span><img src="../images/ory_analyzingallocpatterns_.xml_d130160e246.jpg" alt="Allocations: pattern for a short-lived object" /></span>
            
         </p>
         
         
         <p>This code has an object that allocates 11 bytes, and then it is freed at the end of the function. This is a good candidate
            to put a value on the stack. However, if the object has a variable size, and originates from the user, using stack buffers
            should be done carefully. As a compromise between performance and security, you can perform a size verification, and if the
            length of the object is less than the buffer size, it is safe to use the stack buffer; otherwise, if it is more than the buffer
            size, the heap can be allocated. The buffer size can be chosen based on the average size of allocated objects for this particular
            stack trace. 
         </p>
         
         
         <p>Shortsighted <tt>realloc()</tt> functions and short-lived objects are memory allocation patterns which can improve performance of the application, but not
            the memory usage. 
         </p>
         
         
      </div>
      
      
      <div>
         
         <div class="familylinks">
            
            <div class="parentlink"><strong>Parent topic:</strong> <a href="../topic/memory_Memory_Optimization.html" shape="rect">Memory optimization</a></div>
            
         </div>
         
         <div class="relinfo"><strong>Related concepts</strong><br clear="none" />
            
            <div><a href="../topic/memory_ProcessMem_.html" shape="rect">Process memory</a></div>
            
            <div><a href="../topic/memory_Performance_Of_Heap_Allocations.html" shape="rect">Performance of heap allocations</a></div>
            
            <div><a href="../topic/memory_OptHeapMem_.html" shape="rect">Optimizing heap memory</a></div>
            
            <div><a href="../topic/memory_AllocationOverhead_.html" shape="rect">Types of allocation overhead</a></div>
            
            <div><a href="../topic/memory_EstimatingAllocationSize_.html" shape="rect">Estimating the average allocation size</a></div>
            
            <div><a href="../topic/memory_TuningAllocator_.html" shape="rect">Tuning the allocator</a></div>
            
            <div><a href="../topic/memory_OptstaticStackMem_.html" shape="rect">Optimizing static and stack memory</a></div>
            
         </div>
         
      </div>
      
      <div id="custom-footer">
         	
         <p class="copyright-notice"><a href="PLUGINS_ROOT/com.qnx.doc.copyright/topic/copyright_overview.html" style="color:black" shape="rect">Copyright</a> | <a href="http://community.qnx.com/sf/sfmain/do/home" style="color:black" shape="rect">Community</a></p>
         
      </div>
      
   </body>
</html>